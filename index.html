<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>CountDown ! </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
	<link rel="stylesheet" media="screen" href="css/main.css">
    
    <link rel="shortcut icon" type="image/ico" href="assets/images/favicon.ico">
</head>
<body>
    <div class="bg"></div>
    <div class="footer"></div>
    <div class="conteneur">
        <img src="assets/images/tshirt_final_xl_sans_texte.png" id="main" />

        <div class="jaune_clair min chiffre" id="min">00</div>
        <div class="jaune_fonce min unit">m</div>

        <div class="jaune_clair sec chiffre" id="sec">00</div>
        <div class="jaune_fonce sec unit">s</div>

        <!-- Codes by HTML.am -->
        <marquee behavior="scroll" direction="right" class="marquee_1">DevFest Nantes</marquee>
        <marquee behavior="scroll" direction="right" class="marquee_2">DevFest Nantes</marquee>



    </div>
    <div id="opacity">
        <div id="devfestnantes">            
            <img src="assets/images/logo.png"> 
            <div class="title">DevFest Nantes<br><br>2014<br><br><span id="press" class="green">&lt;press start&gt;</span></div>
            <div id="fakemouse"></div>
        </div>
        <video id="iovideo" src="assets/video/video.mp4" width="100%"></video>
    </div>
    <script type="text/javascript">

        var min = document.getElementById('min'),
        sec = document.getElementById('sec'),
        cibleDate = new Date().getTime()+(10 * 1000),// Date.parse('2014-11-07T08:30:00Z'), 
        marquee_1 = document.querySelector('.marquee_1'),
        marquee_2 = document.querySelector('.marquee_2'),
        currentTime = new Date().getTime(),
        context = null,
        sourceKeynote = null,
        keynoteBuffer = null,
        tmpBuffer = null;

        marquee_1.style.display = 'none';
        marquee_2.style.display = 'none';
        setTimeout(function() {
            marquee_1.style.display = '';
            setTimeout(function() {
                marquee_2.style.display = '';
            }, 2500);
        }, 100);

        var cancelInterval = setInterval(function() {
            currentTime+=100;                    
            var tmpDate = new Date(cibleDate - currentTime);
            min.innerHTML = tmpDate.getMinutes() < 10 ? "0"+tmpDate.getMinutes() : tmpDate.getMinutes();
            sec.innerHTML = tmpDate.getSeconds() < 10 ? "0"+tmpDate.getSeconds() : tmpDate.getSeconds();
            if ((cibleDate - currentTime) <= 0 ){
                endCountDown();
            }
        }, 100);

        function endCountDown(){
            sec.innerHTML = "00";
            playKeyNoteSound();
            clearInterval(cancelInterval);
            document.getElementById('opacity').classList.add('black');
            setTimeout(afterOpacity, 4000);
        }

        function afterOpacity(){
            document.getElementById('devfestnantes').classList.add('show');
            setTimeout(mouveMouse, 3000);     
        }

        function mouveMouse(){
            var fakeMouse = document.getElementById('fakemouse');
            var press = document.getElementById('press');
            var rectPress = press.getBoundingClientRect();
            var rectMouse = fakeMouse.getBoundingClientRect();
            fakeMouse.style.left = (rectPress.left + (rectPress.width / 2))+"px";
            fakeMouse.style.bottom = (window.innerHeight - rectPress.bottom - rectMouse.height)+"px";
            setTimeout(mouseClicked, 3000);
        }

        function mouseClicked(){
            var fakeMouse = document.getElementById('fakemouse');
            fakeMouse.classList.add('clicked');
            setTimeout(startVideo, 500);
        }

        function startVideo(){

            var videoElt = document.getElementById('iovideo');
            videoElt.classList.add('show');
            var devfestElt = document.getElementById('devfestnantes');
            devfestElt.classList.remove('show');
            devfestElt.classList.add('hide');
            videoElt.play();

        }



        function loadSound(url, bufferToUse){
            try{
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';

                // Decode asynchronously
                request.onload = function() {
                    context.decodeAudioData(request.response, function(buffer) {
                        if (bufferToUse){

                        }else{
                            keynoteBuffer = buffer;                    
                        }
                    }, function(e){
                        console.log('Error decoding file', e);
                    });
                }
                request.send();
            }catch(err){
                console.error(err);
            }
        }

        function playSound(buffer){            
            var source = context.createBufferSource(); // creates a sound source
            source.buffer = buffer;                    // tell the source which sound to play
            source.connect(context.destination);       // connect the source to the context's destination (the speakers)
            source.start(0);                           // play the source now
            return source;
        }

        function loadSounds(){
            try{
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                context = new AudioContext();
            }catch(e){
                console.log("No WebAPI dectect");
            }

            loadSound('assets/songs/Porter_Robinson_-_Sea_Of_Voices_(RAC_Mix).mp3');

            
        }

        function playKeyNoteSound(){
            try{

                playSound(keynoteBuffer);
            }catch(err){
                console.error(err);
            }
        }


        loadSounds();

    </script>
</body>
</html>
